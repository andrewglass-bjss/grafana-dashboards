{"meta":{"type":"db","canSave":false,"canEdit":true,"canAdmin":false,"canStar":true,"slug":"cloudflare-traffic-overview","url":"/d/sPqgMv9Zk/cloudflare-traffic-overview","expires":"0001-01-01T00:00:00Z","created":"2020-03-24T13:30:01Z","updated":"2021-09-16T22:48:37Z","updatedBy":"ops-contact@gitlab.com","createdBy":"ops-contact@gitlab.com","version":33,"hasAcl":false,"isFolder":false,"folderId":1258,"folderTitle":"Cloudflare","folderUrl":"/dashboards/f/H4-RMvrZk/cloudflare","provisioned":false,"provisionedExternalId":""},"dashboard":{"annotations":{"list":[{"$$hashKey":"object:13","builtIn":1,"datasource":"-- Grafana --","enable":true,"hide":true,"iconColor":"rgba(0, 211, 255, 1)","name":"Annotations \u0026 Alerts","type":"dashboard"}]},"editable":true,"gnetId":null,"graphTooltip":0,"id":null,"iteration":1631821439458,"links":[],"panels":[{"datasource":null,"description":"","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"gridPos":{"h":10,"w":24,"x":0,"y":0},"id":8,"options":{"content":"### Note: Metrics less than 5 minutes in the past are **not** valid. The exporter scrapes 5 minutes in the past.\n\nPlease select the Cloudflare zone you wish to see metrics for and the appropriate GitLab environment.\n\n`staging.gitlab.com` is scraped as part of `gstg`. `gitlab.net` and `gitlab.com` are scraped in `gprd`.\n\nThe Cloudflare / HAProxy comparison view shows Cloudflare at the bottom and HAProxy on top.  \nThe request count is unlikely to ever match, as Cloudflare will report cached responses, which never hit our backend, and the HAProxy metric also contains the internal LB as well as registry.\n\nThe `WAF quick view` should provide you with an easy view if something is outside the norm.  \nBlocked/Challenged is expected to be ~50-200 req/s depending on the time of day. `503 served by us` indicates a failure on our end, which we were still able to respond to. `Origin unreachable` is really bad, as this indicates requests that Cloudflare was unable to reach us for. If any of the latter 2 metrics are above 0, we might have networking issues, or are saturated.\n\n`Cloudflare WAF actions` view shows what kind of actions the firewall took. You should see an overwhelming amount of `bypass` traffic. If you see a surge in any action taken by the firewall, we might be under attack.\n\n`Traffic by country code` can give us possible insight, if there should be an attack, where that traffic is originating. This is reported by Cloudflare.","mode":"markdown"},"pluginVersion":"7.1.0","timeFrom":null,"timeShift":null,"title":"Cloudflare Traffic overview","type":"text"},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"Note: HAProxy traffic will in almost all cases be higher, as it also includes traffic from the internal load balancer, whereas Cloudflare does not.","fieldConfig":{"defaults":{"custom":{},"links":[]},"overrides":[]},"fill":5,"fillGradient":7,"gridPos":{"h":16,"w":12,"x":0,"y":10},"hiddenSeries":false,"id":2,"interval":"30s","legend":{"alignAsTable":true,"avg":true,"current":true,"max":true,"min":true,"rightSide":false,"show":true,"total":false,"values":true},"lines":true,"linewidth":1,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[{"$$hashKey":"object:556","alias":"/Cloudflare/","transform":"negative-Y"}],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"sum(rate(cloudflare_zones_http_responses_total{zone=~\"$cloudflare_zone\", edge_response_status=~\"2..\"}[5m])) by (zone)","interval":"","intervalFactor":2,"legendFormat":"Cloudflare {{zone}} 2xx","refId":"A"},{"expr":"sum(rate(cloudflare_zones_http_responses_total{zone=~\"$cloudflare_zone\", edge_response_status=~\"5..\"}[5m])) by (zone)","interval":"","intervalFactor":2,"legendFormat":"Cloudflare {{zone}} 5xx","refId":"C"},{"expr":"sum(rate(haproxy_frontend_http_responses_total{code=\"2xx\",env=~\"$gitlab_env\", frontend=\"https\"} [5m])) by (env)","interval":"","intervalFactor":2,"legendFormat":"HAProxy {{env}} 2xx","refId":"B"},{"expr":"sum(rate(haproxy_frontend_http_responses_total{code=\"5xx\",env=~\"$gitlab_env\", frontend=\"https\"} [5m])) by (env)","interval":"","intervalFactor":2,"legendFormat":"HAProxy {{env}} 5xx","refId":"D"},{"expr":"sum(rate(cloudflare_zones_http_responses_total{zone=~\"$cloudflare_zone\", edge_response_status=~\"4..\"}[5m])) by (zone)","interval":"","intervalFactor":2,"legendFormat":"Cloudflare {{zone}} 4xx","refId":"E"},{"expr":"sum(rate(haproxy_frontend_http_responses_total{code=\"4xx\",env=~\"$gitlab_env\", frontend=\"https\"} [5m])) by (env)","interval":"","intervalFactor":2,"legendFormat":"HAProxy {{env}} 4xx","refId":"F"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":"5m","title":"Cloudflare / HAProxy served responses","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"transparent":true,"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:569","format":"reqps","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:570","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"This shows ctraffic blocked/challenged by Cloudflare, 503 errors we served as well as requests in which cases our origin was unreachable by Cloudflare","fieldConfig":{"defaults":{"custom":{"align":null,"filterable":false},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":10,"w":12,"x":12,"y":10},"hiddenSeries":false,"id":12,"interval":"30s","legend":{"alignAsTable":true,"avg":false,"current":true,"hideEmpty":false,"hideZero":false,"max":true,"min":true,"rightSide":true,"show":true,"total":false,"values":true},"lines":true,"linewidth":1,"nullPointMode":"connected","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"sum(rate(cloudflare_zones_firewall_events_total{zone=~\"$cloudflare_zone\", action!=\"bypass\"}[5m])) by (edgeResponseStatus, originResponseStatus, ruleID, zone, action)","hide":true,"interval":"","intervalFactor":2,"legendFormat":"","refId":"A"},{"expr":"sum(rate(cloudflare_zones_firewall_events_total{zone=~\"$cloudflare_zone\", edgeResponseStatus=~\"52(2|3)\", originResponseStatus=\"0\"}[5m])) or vector(0)","interval":"","legendFormat":"Origin unreachable","refId":"C"},{"expr":"sum(rate(cloudflare_zones_firewall_events_total{zone=~\"$cloudflare_zone\", edgeResponseStatus=~\"503\", originResponseStatus=\"503\"}[5m])) or vector(0)","interval":"","legendFormat":"503 served by us","refId":"D"},{"expr":"sum(rate(cloudflare_zones_firewall_events_total{zone=~\"$cloudflare_zone\", edgeResponseStatus=~\"503\", originResponseStatus=\"0\"}[5m])) or vector(0)","interval":"","legendFormat":"Blocked/Challenged","refId":"E"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":"5m","title":"WAF quick view","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:1318","format":"reqps","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:1319","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"fieldConfig":{"defaults":{"custom":{"align":null,"filterable":false},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]}},"overrides":[]},"fill":1,"fillGradient":0,"gridPos":{"h":11,"w":12,"x":12,"y":20},"hiddenSeries":false,"hideTimeOverride":false,"id":10,"interval":"30s","legend":{"alignAsTable":false,"avg":false,"current":false,"hideEmpty":true,"hideZero":true,"max":false,"min":false,"rightSide":true,"show":false,"sort":"current","sortDesc":true,"total":false,"values":false},"lines":true,"linewidth":1,"nullPointMode":"connected","options":{"alertThreshold":false},"percentage":false,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":true,"steppedLine":false,"targets":[{"expr":"sum(rate(cloudflare_zones_http_country_bytes_total{env=\"gprd\"}[5m])) by (zone, client_country_name)","instant":false,"interval":"","intervalFactor":2,"legendFormat":"{{client_country_name}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":"5m","title":"Traffic (Bytes) by country code","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"transparent":true,"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:764","format":"Bps","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:765","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"fieldConfig":{"defaults":{"custom":{},"links":[]},"overrides":[]},"fill":1,"fillGradient":0,"gridPos":{"h":10,"w":12,"x":0,"y":26},"hiddenSeries":false,"id":6,"interval":"30s","legend":{"alignAsTable":true,"avg":true,"current":true,"max":true,"min":true,"show":true,"sort":"current","sortDesc":true,"total":false,"values":true},"lines":true,"linewidth":1,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"sum(rate(cloudflare_zones_firewall_events_total{zone=~\"$cloudflare_zone\"}[5m])) by (zone, action)","interval":"","intervalFactor":2,"legendFormat":"{{zone}} {{action}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":"5m","title":"Cloudflare WAF actions","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"transparent":true,"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:707","format":"reqps","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:708","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"fieldConfig":{"defaults":{"custom":{},"links":[]},"overrides":[]},"fill":10,"fillGradient":0,"gridPos":{"h":10,"w":12,"x":12,"y":31},"hiddenSeries":false,"id":4,"interval":"30s","legend":{"alignAsTable":true,"avg":false,"current":true,"max":true,"min":true,"rightSide":true,"show":true,"total":false,"values":true},"lines":true,"linewidth":0,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":true,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[{"$$hashKey":"object:1950","alias":"HTTP/1.0","color":"#F2495C"},{"$$hashKey":"object:1951","alias":"HTTP/1.1","color":"#FADE2A"},{"$$hashKey":"object:1952","alias":"HTTP/2","color":"#73BF69"}],"spaceLength":10,"stack":true,"steppedLine":false,"targets":[{"expr":"sum(rate(cloudflare_zones_http_protocol_requests_total{zone=~\"$cloudflare_zone\"}[5m])) by (client_http_protocol)","interval":"","intervalFactor":2,"legendFormat":"{{client_http_protocol}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":"5m","title":"Connections by HTTP Protocol version","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"transparent":true,"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:654","format":"short","label":null,"logBase":1,"max":"100","min":"0","show":true},{"$$hashKey":"object:655","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}}],"refresh":"1m","schemaVersion":26,"style":"dark","tags":["unmanaged"],"templating":{"list":[{"allValue":null,"current":{"selected":true,"tags":[],"text":["gitlab.com"],"value":["gitlab.com"]},"datasource":"Global","definition":"label_values(cloudflare_zones_http_responses_total, zone)","hide":0,"includeAll":true,"label":"Cloudflare Zone","multi":true,"name":"cloudflare_zone","options":[{"$$hashKey":"object:274","selected":false,"text":"All","value":"$__all"},{"$$hashKey":"object:275","selected":true,"text":"gitlab.com","value":"gitlab.com"},{"$$hashKey":"object:276","selected":false,"text":"gitlab.net","value":"gitlab.net"},{"$$hashKey":"object:277","selected":false,"text":"staging.gitlab.com","value":"staging.gitlab.com"}],"query":"label_values(cloudflare_zones_http_responses_total, zone)","refresh":0,"regex":"","skipUrlSync":false,"sort":0,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"allValue":null,"current":{"selected":true,"tags":[],"text":["gprd"],"value":["gprd"]},"datasource":"Global","definition":"label_values(haproxy_frontend_http_responses_total, env)","hide":0,"includeAll":true,"label":"GitLab Environment","multi":true,"name":"gitlab_env","options":[{"$$hashKey":"object:126","selected":false,"text":"All","value":"$__all"},{"$$hashKey":"object:127","selected":true,"text":"gprd","value":"gprd"},{"$$hashKey":"object:128","selected":false,"text":"gstg","value":"gstg"}],"query":"label_values(haproxy_frontend_http_responses_total, env)","refresh":0,"regex":"/^g...$/","skipUrlSync":false,"sort":0,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false}]},"time":{"from":"now-3h","to":"now"},"timepicker":{"refresh_intervals":["30s","1m","5m","15m","30m","1h","2h","1d"]},"timezone":"","title":"Cloudflare traffic overview","uid":"sPqgMv9Zk","version":33}}