{"meta":{"type":"db","canSave":true,"canEdit":true,"canAdmin":false,"canStar":true,"slug":"msmiley-2021-02-01-db-perf-regression-due-to-bulk-update-of-namespaces-table-for-ci-minutes-refresh-copy","url":"/d/wpXYrRsMk/msmiley-2021-02-01-db-perf-regression-due-to-bulk-update-of-namespaces-table-for-ci-minutes-refresh-copy","expires":"0001-01-01T00:00:00Z","created":"2021-02-19T21:51:31Z","updated":"2021-02-19T23:02:38Z","updatedBy":"ops-contact@gitlab.com","createdBy":"ops-contact@gitlab.com","version":3,"hasAcl":false,"isFolder":false,"folderId":980,"folderTitle":"Playground - FOR TESTING PURPOSES ONLY","folderUrl":"/dashboards/f/playground-FOR-TESTING-ONLY/playground-for-testing-purposes-only","provisioned":false,"provisionedExternalId":""},"dashboard":{"annotations":{"list":[{"builtIn":1,"datasource":"-- Grafana --","enable":true,"hide":true,"iconColor":"rgba(0, 211, 255, 1)","name":"Annotations \u0026 Alerts","type":"dashboard"}]},"editable":true,"gnetId":null,"graphTooltip":1,"id":null,"iteration":1613771984843,"links":[],"panels":[{"collapsed":false,"datasource":null,"gridPos":{"h":1,"w":24,"x":0,"y":0},"id":18,"panels":[],"title":"Host metrics","type":"row"},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"Global","description":"Percentage of all CPU cores/hyperthreads","editable":true,"error":false,"fieldConfig":{"defaults":{"custom":{},"links":[]},"overrides":[]},"fill":10,"fillGradient":0,"grid":{},"gridPos":{"h":9,"w":12,"x":0,"y":1},"hiddenSeries":false,"id":10,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":0,"links":[],"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":true,"steppedLine":false,"targets":[{"expr":"avg by (mode) (\n  rate(node_cpu_seconds_total{env=\"gprd\",fqdn=\"$node\",mode!=\"idle\"}[$__rate_interval])\n)","format":"time_series","hide":false,"interval":"15s","intervalFactor":1,"legendFormat":"{{mode}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"CPU usage","tooltip":{"msResolution":false,"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:492","decimals":null,"format":"percentunit","label":"% of all CPUs","logBase":1,"max":"1","min":"0","show":true},{"$$hashKey":"object:493","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"","editable":true,"error":false,"fieldConfig":{"defaults":{"custom":{},"links":[]},"overrides":[]},"fill":10,"fillGradient":0,"grid":{},"gridPos":{"h":9,"w":12,"x":12,"y":1},"hiddenSeries":false,"id":20,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":0,"links":[],"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"$$hashKey":"object:1505","alias":"/write.*/","transform":"negative-Y"}],"spaceLength":10,"stack":true,"steppedLine":false,"targets":[{"dsType":"influxdb","expr":"avg_over_time(node_memory_AnonPages_bytes{env=\"gprd\",fqdn=\"$node\"}[$__interval])","format":"time_series","groupBy":[{"params":["$interval"],"type":"time"},{"params":["null"],"type":"fill"}],"hide":false,"interval":"30s","intervalFactor":1,"legendFormat":"AnonPages","metric":"","policy":"default","refId":"A","resultFormat":"time_series","select":[[{"params":["value"],"type":"field"},{"params":[],"type":"mean"}]],"step":10,"tags":[]},{"dsType":"influxdb","expr":"avg_over_time(node_memory_Buffers_bytes{env=\"gprd\",fqdn=\"$node\"}[$__interval])","format":"time_series","groupBy":[{"params":["$interval"],"type":"time"},{"params":["null"],"type":"fill"}],"hide":true,"interval":"30s","intervalFactor":1,"legendFormat":"Buffers","metric":"","policy":"default","refId":"B","resultFormat":"time_series","select":[[{"params":["value"],"type":"field"},{"params":[],"type":"mean"}]],"step":10,"tags":[]},{"dsType":"influxdb","expr":"avg_over_time(node_memory_Slab_bytes{env=\"gprd\",fqdn=\"$node\"}[$__interval])","format":"time_series","groupBy":[{"params":["$interval"],"type":"time"},{"params":["null"],"type":"fill"}],"hide":true,"interval":"30s","intervalFactor":1,"legendFormat":"Slab","metric":"","policy":"default","refId":"C","resultFormat":"time_series","select":[[{"params":["value"],"type":"field"},{"params":[],"type":"mean"}]],"step":10,"tags":[]},{"dsType":"influxdb","expr":"avg_over_time(node_memory_Cached_bytes{env=\"gprd\",fqdn=\"$node\"}[$__interval])","format":"time_series","groupBy":[{"params":["$interval"],"type":"time"},{"params":["null"],"type":"fill"}],"hide":true,"interval":"30s","intervalFactor":1,"legendFormat":"Cached","metric":"","policy":"default","refId":"D","resultFormat":"time_series","select":[[{"params":["value"],"type":"field"},{"params":[],"type":"mean"}]],"step":10,"tags":[]}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Memory usage by type","tooltip":{"msResolution":false,"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:1512","decimals":0,"format":"bytes","label":null,"logBase":1,"max":null,"min":"0","show":true},{"$$hashKey":"object:1513","decimals":null,"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"This measures the mean bytes read per wall-clock second from each mounted block device.","editable":true,"error":false,"fieldConfig":{"defaults":{"custom":{},"links":[]},"overrides":[]},"fill":0,"fillGradient":0,"grid":{},"gridPos":{"h":9,"w":12,"x":0,"y":10},"hiddenSeries":false,"id":14,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"dsType":"influxdb","expr":"rate(node_disk_read_bytes_total{env=\"gprd\",fqdn=\"$node\", device!~\"dm.*\"}[$__rate_interval])","format":"time_series","groupBy":[{"params":["$interval"],"type":"time"},{"params":["null"],"type":"fill"}],"hide":false,"interval":"15s","intervalFactor":1,"legendFormat":"{{device}} read rate","metric":"","policy":"default","refId":"A","resultFormat":"time_series","select":[[{"params":["value"],"type":"field"},{"params":[],"type":"mean"}]],"step":10,"tags":[]}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Disk Read Throughput (bytes/sec)","tooltip":{"msResolution":false,"shared":true,"sort":0,"value_type":"cumulative"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:3451","decimals":0,"format":"Bps","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:3452","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"This measures the mean bytes written per wall-clock second from each mounted block device.","editable":true,"error":false,"fieldConfig":{"defaults":{"custom":{},"links":[]},"overrides":[]},"fill":0,"fillGradient":0,"grid":{},"gridPos":{"h":9,"w":12,"x":12,"y":10},"hiddenSeries":false,"id":12,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"dsType":"influxdb","expr":"rate(node_disk_written_bytes_total{env=\"gprd\",fqdn=\"$node\", device!~\"dm.*\"}[$__rate_interval])","format":"time_series","groupBy":[{"params":["$interval"],"type":"time"},{"params":["null"],"type":"fill"}],"hide":false,"interval":"15s","intervalFactor":1,"legendFormat":"{{device}} write rate","metric":"","policy":"default","refId":"A","resultFormat":"time_series","select":[[{"params":["value"],"type":"field"},{"params":[],"type":"mean"}]],"step":10,"tags":[]}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Disk Write Throughput (bytes/sec)","tooltip":{"msResolution":false,"shared":true,"sort":0,"value_type":"cumulative"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:3531","decimals":0,"format":"Bps","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:3532","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"collapsed":false,"datasource":null,"gridPos":{"h":1,"w":24,"x":0,"y":19},"id":16,"panels":[],"title":"Postgres metrics","type":"row"},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":9,"w":12,"x":0,"y":20},"hiddenSeries":false,"id":2,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"pg_total_relation_size_bytes{env=\"gprd\", type=\"patroni\", relname=\"$relname\", fqdn=\"$node\"}","interval":"","legendFormat":"{{relname}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Size of table: $relname","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:43","format":"bytes","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:44","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":9,"w":12,"x":12,"y":20},"hiddenSeries":false,"id":21,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[{"$$hashKey":"object:1277","alias":"approx dead rows","yaxis":2}],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"pg_stat_user_tables_n_dead_tup{env=\"gprd\", type=\"patroni\", relname=\"$relname\", fqdn=\"$node\"}","hide":false,"interval":"","legendFormat":"approx dead rows","refId":"A"},{"expr":"rate(pg_stat_user_tables_n_tup_upd{env=\"gprd\", type=\"patroni\", relname=\"$relname\", fqdn=\"$node\"}[1m])","interval":"","legendFormat":"update rows/sec","refId":"B"},{"expr":"rate(pg_stat_user_tables_n_tup_hot_upd{env=\"gprd\", type=\"patroni\", relname=\"$relname\", fqdn=\"$node\"}[1m])","interval":"","legendFormat":"hot-update rows/sec","refId":"C"},{"expr":"rate(pg_stat_user_tables_n_tup_ins{env=\"gprd\", type=\"patroni\", relname=\"$relname\", fqdn=\"$node\"}[1m])","interval":"","legendFormat":"insert rows/sec","refId":"D"},{"expr":"rate(pg_stat_user_tables_n_tup_del{env=\"gprd\", type=\"patroni\", relname=\"$relname\", fqdn=\"$node\"}[1m])","interval":"","legendFormat":"delete rows/sec","refId":"E"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Rows per second changed for table: $relname (only tracked on primary db)","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:43","format":"ops","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:44","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":9,"w":12,"x":0,"y":29},"hiddenSeries":false,"id":5,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[{"$$hashKey":"object:1158","alias":"Tuples per IndexScan","yaxis":2}],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"rate(pg_stat_user_tables_idx_scan{env=\"gprd\", type=\"patroni\", relname=\"$relname\", fqdn=\"$node\"}[1m])","hide":false,"interval":"","legendFormat":"{{relname}} IndexScans","refId":"A"},{"expr":"rate(pg_stat_user_tables_idx_tup_fetch{env=\"gprd\", type=\"patroni\", relname=\"$relname\", fqdn=\"$node\"}[1m])","interval":"","legendFormat":"{{relname}} Index Tuples fetched","refId":"B"},{"expr":"rate(pg_stat_user_tables_idx_tup_fetch{env=\"gprd\", type=\"patroni\", relname=\"$relname\", fqdn=\"$node\"}[1m]) / rate(pg_stat_user_tables_idx_scan{env=\"gprd\", type=\"patroni\", relname=\"$relname\", fqdn=\"$node\"}[1m])","interval":"","legendFormat":"Tuples per IndexScan","refId":"C"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"IndexScans summed across all indexes of table: $relname","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:43","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:44","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":9,"w":12,"x":12,"y":29},"hiddenSeries":false,"id":6,"legend":{"alignAsTable":true,"avg":true,"current":false,"max":true,"min":false,"show":true,"sort":"max","sortDesc":true,"total":true,"values":true},"lines":true,"linewidth":1,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"rate(pg_stat_user_indexes_idx_scan{env=\"gprd\", type=\"patroni\", relname=\"$relname\", fqdn=\"$node\"}[1m])","hide":false,"interval":"","legendFormat":"{{indexrelname}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"IndexScans for each index of table: $relname","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:43","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:44","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":9,"w":12,"x":0,"y":38},"hiddenSeries":false,"id":8,"legend":{"alignAsTable":true,"avg":true,"current":false,"max":true,"min":false,"show":true,"sort":"max","sortDesc":true,"total":true,"values":true},"lines":true,"linewidth":1,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"rate(pg_stat_user_indexes_idx_tup_read{env=\"gprd\", type=\"patroni\", relname=\"$relname\", fqdn=\"$node\"}[1m])","hide":false,"interval":"","legendFormat":"{{indexrelname}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Index tuples read for each index of table: $relname","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:43","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:44","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":9,"w":12,"x":12,"y":38},"hiddenSeries":false,"id":7,"legend":{"alignAsTable":true,"avg":true,"current":false,"max":true,"min":false,"show":true,"sort":"max","sortDesc":true,"total":true,"values":true},"lines":true,"linewidth":1,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"rate(pg_stat_user_indexes_idx_tup_fetch{env=\"gprd\", type=\"patroni\", relname=\"$relname\", fqdn=\"$node\"}[1m])","hide":false,"interval":"","legendFormat":"{{indexrelname}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Index tuples fetched for each index of table: $relname","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:43","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:44","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}}],"refresh":false,"schemaVersion":26,"style":"dark","tags":[],"templating":{"list":[{"allValue":null,"current":{"selected":true,"text":"patroni-03-db-gprd.c.gitlab-production.internal","value":"patroni-03-db-gprd.c.gitlab-production.internal"},"datasource":"Global","definition":"label_values(up{env=\"gprd\",type=\"patroni\",job=~\"node(-exporter)?\"}, fqdn)","hide":0,"includeAll":false,"label":"Host","multi":false,"name":"node","options":[],"query":"label_values(up{env=\"gprd\",type=\"patroni\",job=~\"node(-exporter)?\"}, fqdn)","refresh":2,"regex":"","skipUrlSync":false,"sort":1,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"allValue":null,"current":{"selected":true,"text":"namespaces","value":"namespaces"},"hide":0,"includeAll":false,"label":"Table Name","multi":false,"name":"relname","options":[{"selected":true,"text":"namespaces","value":"namespaces"},{"selected":false,"text":"namespace_statistics","value":"namespace_statistics"},{"selected":false,"text":"project_statistics","value":"project_statistics"}],"query":"namespaces,namespace_statistics,project_statistics","queryValue":"","skipUrlSync":false,"type":"custom"}]},"time":{"from":"2021-02-01T00:00:00.000Z","to":"2021-02-01T01:25:00.000Z"},"timepicker":{},"timezone":"","title":"msmiley - 2021-02-01 db perf regression due to bulk-update of namespaces table for CI minutes refresh Copy","uid":"wpXYrRsMk","version":3}}