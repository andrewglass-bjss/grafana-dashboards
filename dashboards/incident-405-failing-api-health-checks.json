{"meta":{"type":"db","canSave":false,"canEdit":false,"canAdmin":false,"canStar":true,"slug":"incident-405-failing-api-health-checks","url":"/d/Zy6xM95mk/incident-405-failing-api-health-checks","expires":"0001-01-01T00:00:00Z","created":"2018-08-13T10:11:59Z","updated":"2018-08-15T16:04:12Z","updatedBy":"ops-contact@gitlab.com","createdBy":"ops-contact@gitlab.com","version":21,"hasAcl":false,"isFolder":false,"folderId":184,"folderTitle":".ONCE OFF","folderUrl":"/dashboards/f/kGgx9rIiz/once-off","provisioned":false},"dashboard":{"annotations":{"list":[{"builtIn":1,"datasource":"-- Grafana --","enable":true,"hide":true,"iconColor":"rgba(0, 211, 255, 1)","name":"Annotations \u0026 Alerts","type":"dashboard"}]},"editable":true,"gnetId":null,"graphTooltip":1,"id":null,"links":[],"panels":[{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-01-inf-gprd","fill":1,"gridPos":{"h":9,"w":12,"x":0,"y":0},"id":15,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null as zero","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":true,"steppedLine":false,"targets":[{"expr":"sum(rate(node_disk_read_time_seconds_total{environment=\"gprd\", type=\"gitaly\"}[$__interval]))","format":"time_series","interval":"1m","intervalFactor":5,"legendFormat":"","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Disk Read IO Seconds per Second","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"decimals":null,"format":"short","label":null,"logBase":1,"max":"60","min":"0","show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-01-inf-gprd","fill":1,"gridPos":{"h":9,"w":12,"x":12,"y":0},"id":16,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null as zero","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":true,"steppedLine":false,"targets":[{"expr":"sum(rate(node_disk_write_time_seconds_total{environment=\"gprd\", type=\"gitaly\"}[$__interval]))","format":"time_series","interval":"1m","intervalFactor":5,"legendFormat":"","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Disk Read IO Seconds per Second","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"decimals":null,"format":"short","label":null,"logBase":1,"max":"300","min":"0","show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-01-inf-gprd","fill":0,"gridPos":{"h":9,"w":12,"x":0,"y":9},"id":13,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","percentage":false,"pointradius":0.5,"points":true,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"avg(avg_over_time(probe_duration_seconds{instance=~\"^https://gitlab.com.*\"}[$__interval])) / avg(avg_over_time(probe_duration_seconds{instance=~\"^https://gitlab.com.*\"}[$__interval] offset 1w))","format":"time_series","interval":"1m","intervalFactor":10,"legendFormat":"","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Performance Relative to 1 week ago","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"percentunit","label":null,"logBase":10,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-01-inf-gprd","fill":0,"gridPos":{"h":9,"w":12,"x":12,"y":9},"id":17,"legend":{"alignAsTable":true,"avg":true,"current":false,"max":true,"min":false,"show":true,"sort":"avg","sortDesc":true,"total":false,"values":true},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null as zero","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"avg(rate(node_disk_write_time_seconds_total{type=\"gitaly\", device=\"sdb\"}[$__interval]) / rate(node_disk_writes_completed_total[$__interval])) by (fqdn)","format":"time_series","interval":"1m","intervalFactor":5,"legendFormat":"{{ fqdn }}: sdb","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"GCP: Average Write Operation Time (log10)","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"decimals":null,"format":"s","label":null,"logBase":10,"max":"0.3","min":"0.0001","show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-01-inf-gprd","fill":0,"gridPos":{"h":9,"w":12,"x":0,"y":18},"id":12,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","percentage":false,"pointradius":0.5,"points":true,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"avg_over_time(probe_duration_seconds{instance=~\"^https://gitlab.com.*\"}[$__interval]) / avg_over_time(probe_duration_seconds{instance=~\"^https://gitlab.com.*\"}[$__interval] offset 1w)","format":"time_series","interval":"1m","intervalFactor":10,"legendFormat":"","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Performance Relative to 1 week ago","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"percentunit","label":null,"logBase":10,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-01-inf-gprd","fill":0,"gridPos":{"h":9,"w":12,"x":12,"y":18},"id":18,"legend":{"alignAsTable":true,"avg":true,"current":false,"max":true,"min":false,"rightSide":false,"show":true,"sort":"avg","sortDesc":true,"total":false,"values":true},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null as zero","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"avg(rate(node_disk_read_time_seconds_total{type=\"gitaly\", device=\"sdb\"}[$__interval]) / rate(node_disk_reads_completed_total[$__interval])) by (fqdn, device)","format":"time_series","interval":"1m","intervalFactor":5,"legendFormat":"{{ fqdn }}, {{ device}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"GCP: Average Read Operation Duration","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"decimals":null,"format":"s","label":null,"logBase":10,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-app-01-inf-gprd","fill":1,"gridPos":{"h":9,"w":12,"x":0,"y":27},"id":10,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"histogram_quantile(0.95, sum(rate(gitlab_workhorse_queueing_waiting_time_bucket{environment=\"gprd\"}[$__interval])) by (le, tier))\n\n\n\n","format":"time_series","intervalFactor":1,"legendFormat":"{{ tier }}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"p95 Workhorse Queuing Waiting Duration","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-01-inf-gprd","fill":1,"gridPos":{"h":9,"w":12,"x":12,"y":27},"id":6,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"histogram_quantile(0.95, sum(rate(grpc_server_handling_seconds_bucket{job=\"gitaly\", grpc_type=\"unary\", environment=\"gprd\"}[$__interval])) by (le))","format":"time_series","hide":false,"interval":"1m","intervalFactor":5,"legendFormat":"p95","refId":"A"},{"expr":"histogram_quantile(0.99, sum(rate(grpc_server_handling_seconds_bucket{job=\"gitaly\", grpc_type=\"unary\", environment=\"gprd\"}[$__interval])) by (le))","format":"time_series","hide":false,"interval":"1m","intervalFactor":5,"legendFormat":"p99","refId":"B"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Gitaly Unary Durations","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"s","label":null,"logBase":10,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-app-01-inf-gprd","decimals":2,"fill":0,"gridPos":{"h":9,"w":12,"x":0,"y":36},"id":8,"legend":{"alignAsTable":true,"avg":true,"current":true,"max":true,"min":true,"rightSide":false,"show":true,"sort":"avg","sortDesc":true,"total":false,"values":true},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"histogram_quantile(0.95, sum(rate(gitlab_workhorse_http_request_duration_seconds_bucket{environment=\"gprd\", route=~\"^($|\\\\^/api/)\"}[5m])) by (route, le))\n","format":"time_series","interval":"1m","intervalFactor":1,"legendFormat":"p95: {{ route }}","refId":"A"},{"expr":"histogram_quantile(0.99, sum(rate(gitlab_workhorse_http_request_duration_seconds_bucket{environment=\"gprd\", route=~\"^($|\\\\^/api/)\"}[5m])) by (route, le))\n","format":"time_series","intervalFactor":1,"legendFormat":"p99: {{ route }}","refId":"B"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Workhorse API and Web durations","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"s","label":null,"logBase":1,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-app-01-inf-gprd","decimals":2,"fill":0,"gridPos":{"h":9,"w":12,"x":12,"y":36},"id":20,"legend":{"alignAsTable":true,"avg":true,"current":true,"max":true,"min":true,"rightSide":false,"show":true,"sort":"avg","sortDesc":true,"total":false,"values":true},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"\nsum(gitlab_workhorse_http_in_flight_requests) by (type)","format":"time_series","interval":"1m","intervalFactor":1,"legendFormat":"","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Workhorse Requests in Progress","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-app-01-inf-gprd","fill":1,"gridPos":{"h":9,"w":12,"x":0,"y":45},"id":4,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"sum(unicorn_queued_connections{fqdn=~\"^api.*\"})","format":"time_series","interval":"1m","intervalFactor":1,"legendFormat":"api","refId":"A"},{"expr":"sum(unicorn_queued_connections{fqdn=~\"^web.*\"})","format":"time_series","interval":"1m","intervalFactor":1,"legendFormat":"web","refId":"B"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Unicorn Queued Connections","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-app-01-inf-gprd","decimals":2,"fill":0,"gridPos":{"h":9,"w":12,"x":12,"y":45},"id":21,"legend":{"alignAsTable":true,"avg":true,"current":true,"max":true,"min":true,"rightSide":false,"show":true,"sort":"avg","sortDesc":true,"total":false,"values":true},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null as zero","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":""}],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"sum(rate(gitlab_workhorse_http_requests_total{environment=\"gprd\"}[$__interval])) by (type, code) / ignoring(code)\ngroup_left\nsum(rate(gitlab_workhorse_http_requests_total{environment=\"gprd\"}[$__interval])) by (type) ","format":"time_series","hide":false,"interval":"1m","intervalFactor":5,"legendFormat":"{{ type }}: {{ code }}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Workhorse Error Responses","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"percentunit","label":null,"logBase":1,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-01-inf-gprd","fill":1,"gridPos":{"h":9,"w":12,"x":0,"y":54},"id":2,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"avg(haproxy_server_up{environment=\"gprd\", backend=\"api\"})","format":"time_series","interval":"","intervalFactor":1,"legendFormat":"","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"API Backend Health","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"decimals":null,"format":"percentunit","label":null,"logBase":1,"max":"1","min":"0","show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"prometheus-01-inf-gprd","fill":0,"gridPos":{"h":9,"w":12,"x":12,"y":54},"id":19,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"avg(rate(grpc_server_handling_seconds_sum{job=\"gitaly\", grpc_type=\"unary\", environment=\"gprd\"}[$__interval]) / \n(rate(grpc_server_handling_seconds_count{job=\"gitaly\", grpc_type=\"unary\", environment=\"gprd\"}[$__interval]) \u003e 0))  ","format":"time_series","hide":false,"interval":"1m","intervalFactor":5,"legendFormat":"","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Gitaly Average Durations","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"s","label":null,"logBase":10,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}}],"refresh":false,"schemaVersion":16,"style":"dark","tags":[],"templating":{"list":[]},"time":{"from":"now-6h","to":"now"},"timepicker":{"refresh_intervals":["5s","10s","30s","1m","5m","15m","30m","1h","2h","1d"],"time_options":["5m","15m","1h","6h","12h","24h","2d","7d","30d"]},"timezone":"","title":"Incident: 405: Failing API Health Checks","uid":"Zy6xM95mk","version":21}}