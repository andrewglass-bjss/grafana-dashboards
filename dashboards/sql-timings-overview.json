{"meta":{"type":"db","canSave":true,"canEdit":true,"canStar":true,"slug":"sql-timings-overview","expires":"0001-01-01T00:00:00Z","created":"2017-09-26T13:02:56Z","updated":"2018-05-29T17:01:28Z","updatedBy":"ops-contact@gitlab.com","createdBy":"ops-contact@gitlab.com","version":29},"dashboard":{"annotations":{"list":[{"builtIn":1,"datasource":"-- Grafana --","enable":true,"hide":true,"iconColor":"rgba(0, 211, 255, 1)","name":"Annotations \u0026 Alerts","type":"dashboard"}]},"description":"Time spent in SQL queries per controller.","editable":true,"gnetId":null,"graphTooltip":0,"hideControls":false,"id":null,"links":[{"icon":"external link","includeVars":true,"keepTime":true,"tags":["postgresql"],"targetBlank":true,"type":"dashboards"}],"refresh":false,"rows":[{"collapse":false,"height":250,"panels":[{"columns":[],"datasource":"$database","editable":true,"error":false,"fontSize":"100%","height":"","id":18,"links":[],"pageSize":50,"scroll":false,"showHeader":true,"sort":{"col":2,"desc":true},"span":12,"styles":[{"alias":"","colorMode":"cell","colors":["rgba(50, 189, 80, 0.9)","rgba(237, 129, 40, 0.89)","rgba(200, 72, 72, 0.97)","rgba(137, 15, 2, 0.97)"],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":0,"pattern":"/Mean|95th Perc|99th Perc/","thresholds":["100","200","1000"],"type":"number","unit":"ms"},{"colorMode":null,"colors":["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)","rgba(137, 15, 2, 0.97)"],"dateFormat":"YYYY-MM-DD","decimals":2,"pattern":"Time","thresholds":[],"type":"date","unit":"short"},{"colorMode":null,"colors":["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)","rgba(137, 15, 2, 0.97)"],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":0,"pattern":"Amount","thresholds":[],"type":"number","unit":"short"},{"alias":"","colorMode":"cell","colors":["rgba(50, 189, 80, 0)","rgba(237, 129, 40, 0)","rgba(200, 72, 72, 0.97)","rgba(137, 15, 2, 0.97)"],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":0,"pattern":"Percentage of Request Time","thresholds":["40","50"],"type":"number","unit":"percent"}],"targets":[{"alias":"$col","dsType":"influxdb","groupBy":[],"hide":false,"measurement":"transactions","orderByTime":"ASC","policy":"default","query":"SELECT \"action\", \"count\" as \"Amount\", (sql_duration_99th / duration_99th) * 100.0 AS \"Percentage of Request Time\", \"sql_duration_mean\" AS \"Mean\", \"sql_duration_95th\" AS \"95th Percentile\", \"sql_duration_99th\" AS \"99th Percentile\" FROM downsampled.\"[[process_type]]_transaction_timings_per_action_per_day\" WHERE $timeFilter AND action =~ /[[action]]/ AND count \u003e [[commonly_used]] AND action !~ [[ignore_actions]] AND sql_duration_99th \u003e= [[minimum_p99]] AND (sql_duration_99th / duration_99th)*100 \u003e [[minimum_sql]] ORDER BY time DESC","rawQuery":true,"refId":"A","resultFormat":"table","select":[[{"params":["duration"],"type":"field"}],[{"params":["method"],"type":"field"}],[{"params":["path"],"type":"field"}]],"tags":[]}],"timeFrom":"24h","title":"Controllers with more than [[commonly_used]] requests","transform":"table","transparent":false,"type":"table"}],"repeat":null,"repeatIteration":null,"repeatRowId":null,"showTitle":true,"title":"Frequently Used (P2)","titleSize":"h6"},{"collapse":false,"height":250,"panels":[{"columns":[],"datasource":"$database","editable":true,"error":false,"fontSize":"100%","height":"","id":12,"links":[],"pageSize":50,"scroll":false,"showHeader":true,"sort":{"col":2,"desc":true},"span":12,"styles":[{"alias":"","colorMode":"cell","colors":["rgba(50, 189, 80, 0.9)","rgba(237, 129, 40, 0.89)","rgba(200, 72, 72, 0.97)","rgba(137, 15, 2, 0.97)"],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":0,"pattern":"/Mean|95th Perc|99th Perc/","thresholds":["100","200","1000"],"type":"number","unit":"ms"},{"colorMode":null,"colors":["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)","rgba(137, 15, 2, 0.97)"],"dateFormat":"YYYY-MM-DD","decimals":2,"pattern":"Time","thresholds":[],"type":"date","unit":"short"},{"colorMode":null,"colors":["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)","rgba(137, 15, 2, 0.97)"],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":0,"pattern":"Amount","thresholds":[],"type":"number","unit":"short"},{"alias":"","colorMode":"cell","colors":["rgba(50, 189, 80, 0)","rgba(237, 129, 40, 0)","rgba(200, 72, 72, 0.97)","rgba(137, 15, 2, 0.97)"],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":0,"pattern":"Percentage of Request Time","thresholds":["40","50"],"type":"number","unit":"percent"}],"targets":[{"alias":"$col","dsType":"influxdb","groupBy":[],"hide":false,"measurement":"transactions","orderByTime":"ASC","policy":"default","query":"SELECT \"action\", \"count\" as \"Amount\", (sql_duration_99th / duration_99th) * 100.0 AS \"Percentage of Request Time\", \"sql_duration_mean\" AS \"Mean\", \"sql_duration_95th\" AS \"95th Percentile\", \"sql_duration_99th\" AS \"99th Percentile\" FROM downsampled.\"[[process_type]]_transaction_timings_per_action_per_day\" WHERE $timeFilter AND action =~ /[[action]]/ AND count \u003e [[rarely_used]] AND count \u003c= [[commonly_used]] AND action !~ [[ignore_actions]] AND sql_duration_99th \u003e= [[minimum_p99]]  AND (sql_duration_99th / duration_99th)*100 \u003e [[minimum_sql]] ORDER BY time DESC","rawQuery":true,"refId":"A","resultFormat":"table","select":[[{"params":["duration"],"type":"field"}],[{"params":["method"],"type":"field"}],[{"params":["path"],"type":"field"}]],"tags":[]}],"timeFrom":"24h","title":"Controllers with request counts between [[rarely_used]] and [[commonly_used]]","transform":"table","transparent":false,"type":"table"}],"repeat":null,"repeatIteration":null,"repeatRowId":null,"showTitle":true,"title":"Commonly Used (P3)","titleSize":"h6"},{"collapse":false,"height":"","panels":[{"columns":[],"datasource":"$database","editable":true,"error":false,"fontSize":"100%","height":"","id":19,"links":[],"minSpan":12,"pageSize":50,"scroll":false,"showHeader":true,"sort":{"col":2,"desc":true},"span":12,"styles":[{"alias":"","colorMode":"cell","colors":["rgba(50, 189, 80, 0.9)","rgba(237, 129, 40, 0.89)","rgba(200, 72, 72, 0.97)","rgba(137, 15, 2, 0.97)"],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":0,"pattern":"/Mean|95th Perc|99th Perc/","thresholds":["100","200","1000"],"type":"number","unit":"ms"},{"colorMode":null,"colors":["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)","rgba(137, 15, 2, 0.97)"],"dateFormat":"YYYY-MM-DD","decimals":2,"pattern":"Time","thresholds":[],"type":"date","unit":"short"},{"colorMode":null,"colors":["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)","rgba(137, 15, 2, 0.97)"],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":0,"pattern":"Amount","thresholds":[],"type":"number","unit":"short"},{"alias":"","colorMode":"cell","colors":["rgba(50, 189, 80, 0)","rgba(237, 129, 40, 0)","rgba(200, 72, 72, 0.97)","rgba(137, 15, 2, 0.97)"],"dateFormat":"YYYY-MM-DD HH:mm:ss","decimals":0,"pattern":"Percentage of Request Time","thresholds":["40","50"],"type":"number","unit":"percent"}],"targets":[{"alias":"$col","dsType":"influxdb","groupBy":[],"hide":false,"measurement":"transactions","orderByTime":"ASC","policy":"default","query":"SELECT \"action\", \"count\" as \"Amount\", (sql_duration_99th / duration_99th) * 100.0 AS \"Percentage of Request Time\", \"sql_duration_mean\" AS \"Mean\", \"sql_duration_95th\" AS \"95th Percentile\", \"sql_duration_99th\" AS \"99th Percentile\" FROM downsampled.\"[[process_type]]_transaction_timings_per_action_per_day\" WHERE $timeFilter AND action =~ /[[action]]/ AND count \u003c= [[rarely_used]] AND count \u003e= [[minimum_requests]] AND action !~ [[ignore_actions]] AND sql_duration_99th \u003e= [[minimum_p99]]  AND (sql_duration_99th / duration_99th)*100 \u003e [[minimum_sql]] ORDER BY time DESC","rawQuery":true,"refId":"A","resultFormat":"table","select":[[{"params":["duration"],"type":"field"}],[{"params":["method"],"type":"field"}],[{"params":["path"],"type":"field"}]],"tags":[]}],"timeFrom":"24h","title":"Controllers with request counts between [[minimum_requests]] and  [[rarely_used]]","transform":"table","transparent":false,"type":"table"}],"repeat":null,"repeatIteration":null,"repeatRowId":null,"showTitle":true,"title":"Rarely Used (P4)","titleSize":"h6"}],"schemaVersion":14,"style":"dark","tags":["controller","sql","postgresql"],"templating":{"list":[{"allValue":null,"current":{"selected":false,"tags":[],"text":"rails","value":"rails"},"datasource":null,"hide":0,"includeAll":false,"label":"Process Type","multi":false,"name":"process_type","options":[{"selected":true,"text":"rails","value":"rails"},{"selected":false,"text":"sidekiq","value":"sidekiq"},{"selected":false,"text":"grape","value":"grape"}],"query":"rails,sidekiq,grape","refresh":0,"type":"custom"},{"allValue":".+","current":{"text":"All","value":"$__all"},"datasource":"Production","hide":0,"includeAll":true,"label":"Action","multi":false,"name":"action","options":[],"query":"SHOW TAG VALUES FROM gitlab.downsampled.[[process_type]]_transaction_counts_per_action WITH KEY = \"action\"","refresh":1,"regex":"/#/","sort":0,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"current":{"text":"Production","value":"Production"},"datasource":null,"hide":0,"includeAll":false,"label":"Database","multi":false,"name":"database","options":[],"query":"influxdb","refresh":1,"regex":"","type":"datasource"},{"current":{"text":"10000","value":"10000"},"hide":0,"label":"Minimum Requests","name":"minimum_requests","options":[{"selected":true,"text":"10000","value":"10000"}],"query":"10000","type":"constant"},{"current":{"text":"30000","value":"30000"},"hide":0,"label":"Rarely Used Threshold","name":"rarely_used","options":[{"selected":true,"text":"30000","value":"30000"}],"query":"30000","type":"constant"},{"current":{"text":"100000","value":"100000"},"hide":0,"label":"Commonly Used Threshold","name":"commonly_used","options":[{"selected":true,"text":"100000","value":"100000"}],"query":"100000","type":"constant"},{"current":{"selected":true,"text":"/^(Gitlab::RequestForgery|RootController|MetricsController)/","value":"/^(Gitlab::RequestForgery|RootController|MetricsController)/"},"hide":2,"label":"Actions To Ignore","name":"ignore_actions","options":[{"selected":true,"text":"/^(Gitlab::RequestForgery|RootController|MetricsController)/","value":"/^(Gitlab::RequestForgery|RootController|MetricsController)/"}],"query":"/^(Gitlab::RequestForgery|RootController|MetricsController)/","type":"constant"},{"current":{"selected":true,"text":"100","value":"100"},"hide":0,"label":"Minimum 99th Percentile","name":"minimum_p99","options":[{"selected":true,"text":"100","value":"100"}],"query":"100","type":"constant"},{"current":{"text":"10","value":"10"},"hide":0,"label":"Minimum % Req Time","name":"minimum_sql","options":[{"selected":true,"text":"0","value":"0"}],"query":"0","type":"constant"}]},"time":{"from":"now-24h","to":"now"},"timepicker":{"now":true,"refresh_intervals":["5s","10s","30s","1m","5m","15m","30m","1h","2h","1d"],"time_options":["5m","15m","1h","6h","12h","24h","2d","7d","30d"]},"timezone":"utc","title":"SQL Timings Overview","version":29}}