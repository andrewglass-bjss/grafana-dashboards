{"meta":{"type":"db","canSave":true,"canEdit":true,"canAdmin":false,"canStar":true,"slug":"msmiley-postgres-disk-latency-induced-client-connection-spikes-copy","url":"/d/YGZyMQBMz/msmiley-postgres-disk-latency-induced-client-connection-spikes-copy","expires":"0001-01-01T00:00:00Z","created":"2021-01-23T01:06:41Z","updated":"2021-01-23T01:40:31Z","updatedBy":"ops-contact@gitlab.com","createdBy":"ops-contact@gitlab.com","version":3,"hasAcl":false,"isFolder":false,"folderId":980,"folderTitle":"Playground - FOR TESTING PURPOSES ONLY","folderUrl":"/dashboards/f/playground-FOR-TESTING-ONLY/playground-for-testing-purposes-only","provisioned":false,"provisionedExternalId":""},"dashboard":{"annotations":{"list":[{"builtIn":1,"datasource":"-- Grafana --","enable":true,"hide":true,"iconColor":"rgba(0, 211, 255, 1)","name":"Annotations \u0026 Alerts","type":"dashboard"}]},"editable":true,"gnetId":null,"graphTooltip":1,"id":null,"iteration":1611364002307,"links":[],"panels":[{"collapsed":false,"datasource":null,"gridPos":{"h":1,"w":24,"x":0,"y":0},"id":25,"panels":[],"title":"README - How to use this dashboard","type":"row"},{"datasource":null,"description":"","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"gridPos":{"h":5,"w":24,"x":0,"y":1},"id":23,"options":{"content":"1. Select up to a 24-hour timespan to explore.\n2. Find a spike on the graph counting new incoming network connections.\n3.  Zoom-in on the smaller timespan around that spike.\n4. Select the patroni host with the spike, and optionally other patroni hosts for comparison.\n5. Unfold the other rows on this dashboard to compare those hosts.","mode":"markdown"},"pluginVersion":"7.1.0","timeFrom":null,"timeShift":null,"title":"Usage notes","type":"text"},{"collapsed":false,"datasource":null,"gridPos":{"h":1,"w":24,"x":0,"y":6},"id":6,"panels":[],"title":"Network connection rate by host","type":"row"},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":9,"w":24,"x":0,"y":7},"hiddenSeries":false,"id":2,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"increase(node_netstat_Tcp_PassiveOpens{fqdn=~\"patroni-.*\", env=\"gprd\", shard=\"default\"}[1m])","interval":"120","legendFormat":"{{fqdn}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Count of new incoming connections","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:56","format":"short","label":null,"logBase":1,"max":null,"min":"0","show":true},{"$$hashKey":"object:57","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"collapsed":true,"datasource":null,"gridPos":{"h":1,"w":24,"x":0,"y":16},"id":8,"panels":[{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":10,"fillGradient":0,"gridPos":{"h":8,"w":12,"x":0,"y":12},"hiddenSeries":false,"id":4,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":0,"maxPerRow":2,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","repeat":"node","repeatDirection":"h","scopedVars":{"node":{"selected":true,"text":"patroni-01","value":"patroni-01"}},"seriesOverrides":[],"spaceLength":10,"stack":true,"steppedLine":false,"targets":[{"expr":"avg by (mode,fqdn) (\n  rate(node_cpu_seconds_total{env=\"gprd\",fqdn=~\"${node}-db-gprd.c.gitlab-production.internal\",mode!=\"idle\"}[$__rate_interval])\n)","hide":false,"interval":"15","legendFormat":"{{mode}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"$node - CPU","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:195","format":"percentunit","label":null,"logBase":1,"max":"1","min":"0","show":true},{"$$hashKey":"object:196","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":10,"fillGradient":0,"gridPos":{"h":8,"w":12,"x":12,"y":12},"hiddenSeries":false,"id":26,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":0,"maxPerRow":2,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":2,"points":false,"renderer":"flot","repeatDirection":"h","repeatIteration":1611364002307,"repeatPanelId":4,"scopedVars":{"node":{"selected":true,"text":"patroni-04","value":"patroni-04"}},"seriesOverrides":[],"spaceLength":10,"stack":true,"steppedLine":false,"targets":[{"expr":"avg by (mode,fqdn) (\n  rate(node_cpu_seconds_total{env=\"gprd\",fqdn=~\"${node}-db-gprd.c.gitlab-production.internal\",mode!=\"idle\"}[$__rate_interval])\n)","hide":false,"interval":"15","legendFormat":"{{mode}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"$node - CPU","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:195","format":"percentunit","label":null,"logBase":1,"max":"1","min":"0","show":true},{"$$hashKey":"object:196","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}}],"title":"CPU usage by host","type":"row"},{"collapsed":true,"datasource":null,"gridPos":{"h":1,"w":24,"x":0,"y":17},"id":10,"panels":[{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"This measures the mean duration for each read operation (including time spent in the I/O queue, not just time from Dispatch to Compete).\n\nGood latency should be a few milliseconds; if the graph's scale is in seconds, you have a problem!\n\nHigh read latency and deep I/O queues often occur together.  They can be caused by either increased service time from the block device (slower physical I/O) or increased demand (request arrival rate).  Note that writes can sometimes stall reads.","editable":true,"error":false,"fieldConfig":{"defaults":{"custom":{},"links":[]},"overrides":[]},"fill":0,"fillGradient":0,"grid":{},"gridPos":{"h":7,"w":12,"x":0,"y":12},"hiddenSeries":false,"id":14,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"maxPerRow":2,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","repeat":"node","repeatDirection":"h","scopedVars":{"node":{"selected":true,"text":"patroni-01","value":"patroni-01"}},"seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"dsType":"influxdb","expr":"rate(node_disk_read_time_seconds_total{env=\"gprd\",fqdn=\"${node}-db-gprd.c.gitlab-production.internal\", device=\"sdb\"}[$__rate_interval]) / rate(node_disk_reads_completed_total{env=\"gprd\",fqdn=\"${node}-db-gprd.c.gitlab-production.internal\", device=\"sdb\"}[$__rate_interval]) \u003e 0","format":"time_series","groupBy":[{"params":["$interval"],"type":"time"},{"params":["null"],"type":"fill"}],"hide":false,"interval":"15s","intervalFactor":1,"legendFormat":"{{device}} read latency","metric":"","policy":"default","refId":"A","resultFormat":"time_series","select":[[{"params":["value"],"type":"field"},{"params":[],"type":"mean"}]],"step":10,"tags":[]}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"$node - Mean Duration per Read Op","tooltip":{"msResolution":false,"shared":true,"sort":0,"value_type":"cumulative"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:2793","format":"s","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:2794","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"This measures the mean duration for each read operation (including time spent in the I/O queue, not just time from Dispatch to Compete).\n\nGood latency should be a few milliseconds; if the graph's scale is in seconds, you have a problem!\n\nHigh read latency and deep I/O queues often occur together.  They can be caused by either increased service time from the block device (slower physical I/O) or increased demand (request arrival rate).  Note that writes can sometimes stall reads.","editable":true,"error":false,"fieldConfig":{"defaults":{"custom":{},"links":[]},"overrides":[]},"fill":0,"fillGradient":0,"grid":{},"gridPos":{"h":7,"w":12,"x":12,"y":12},"hiddenSeries":false,"id":20,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"maxPerRow":2,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","repeatDirection":"h","repeatIteration":1611364002303,"repeatPanelId":14,"scopedVars":{"node":{"selected":true,"text":"patroni-04","value":"patroni-04"}},"seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"dsType":"influxdb","expr":"rate(node_disk_read_time_seconds_total{env=\"gprd\",fqdn=\"${node}-db-gprd.c.gitlab-production.internal\", device=\"sdb\"}[$__rate_interval]) / rate(node_disk_reads_completed_total{env=\"gprd\",fqdn=\"${node}-db-gprd.c.gitlab-production.internal\", device=\"sdb\"}[$__rate_interval]) \u003e 0","format":"time_series","groupBy":[{"params":["$interval"],"type":"time"},{"params":["null"],"type":"fill"}],"hide":false,"interval":"15s","intervalFactor":1,"legendFormat":"{{device}} read latency","metric":"","policy":"default","refId":"A","resultFormat":"time_series","select":[[{"params":["value"],"type":"field"},{"params":[],"type":"mean"}]],"step":10,"tags":[]}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"$node - Mean Duration per Read Op","tooltip":{"msResolution":false,"shared":true,"sort":0,"value_type":"cumulative"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:2793","format":"s","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:2794","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}}],"title":"Disk read latency by host","type":"row"},{"collapsed":true,"datasource":null,"gridPos":{"h":1,"w":24,"x":0,"y":18},"id":16,"panels":[{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"This measures the mean duration for each write operation (including time spent in the I/O queue, not just time from Dispatch to Compete).\n\nWrite latency is often slower (due to larger mean operation size) and often runs in the background, so high write latency may not be as serious as read latency.\n\nHowever, writes can stall reads if the reads are not getting promptly scheduled and spending time in the I/O queue.","editable":true,"error":false,"fieldConfig":{"defaults":{"custom":{},"links":[]},"overrides":[]},"fill":0,"fillGradient":0,"grid":{},"gridPos":{"h":7,"w":12,"x":0,"y":14},"hiddenSeries":false,"id":18,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"maxPerRow":2,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","repeat":"node","repeatDirection":"h","scopedVars":{"node":{"selected":true,"text":"patroni-01","value":"patroni-01"}},"seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"dsType":"influxdb","expr":"rate(node_disk_write_time_seconds_total{env=\"gprd\",fqdn=\"${node}-db-gprd.c.gitlab-production.internal\", device=\"sdb\"}[$__rate_interval]) / rate(node_disk_writes_completed_total{env=\"gprd\",fqdn=\"${node}-db-gprd.c.gitlab-production.internal\", device=\"sdb\"}[$__rate_interval]) \u003e 0","format":"time_series","groupBy":[{"params":["$interval"],"type":"time"},{"params":["null"],"type":"fill"}],"hide":false,"interval":"15s","intervalFactor":1,"legendFormat":"{{device}} read latency","metric":"","policy":"default","refId":"A","resultFormat":"time_series","select":[[{"params":["value"],"type":"field"},{"params":[],"type":"mean"}]],"step":10,"tags":[]}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"$node - Mean Duration per Write Op","tooltip":{"msResolution":false,"shared":true,"sort":0,"value_type":"cumulative"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:2793","format":"s","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:2794","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"This measures the mean duration for each write operation (including time spent in the I/O queue, not just time from Dispatch to Compete).\n\nWrite latency is often slower (due to larger mean operation size) and often runs in the background, so high write latency may not be as serious as read latency.\n\nHowever, writes can stall reads if the reads are not getting promptly scheduled and spending time in the I/O queue.","editable":true,"error":false,"fieldConfig":{"defaults":{"custom":{},"links":[]},"overrides":[]},"fill":0,"fillGradient":0,"grid":{},"gridPos":{"h":7,"w":12,"x":12,"y":14},"hiddenSeries":false,"id":27,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":1,"links":[],"maxPerRow":2,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","repeatDirection":"h","repeatIteration":1611364002307,"repeatPanelId":18,"scopedVars":{"node":{"selected":true,"text":"patroni-04","value":"patroni-04"}},"seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"dsType":"influxdb","expr":"rate(node_disk_write_time_seconds_total{env=\"gprd\",fqdn=\"${node}-db-gprd.c.gitlab-production.internal\", device=\"sdb\"}[$__rate_interval]) / rate(node_disk_writes_completed_total{env=\"gprd\",fqdn=\"${node}-db-gprd.c.gitlab-production.internal\", device=\"sdb\"}[$__rate_interval]) \u003e 0","format":"time_series","groupBy":[{"params":["$interval"],"type":"time"},{"params":["null"],"type":"fill"}],"hide":false,"interval":"15s","intervalFactor":1,"legendFormat":"{{device}} read latency","metric":"","policy":"default","refId":"A","resultFormat":"time_series","select":[[{"params":["value"],"type":"field"},{"params":[],"type":"mean"}]],"step":10,"tags":[]}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"$node - Mean Duration per Write Op","tooltip":{"msResolution":false,"shared":true,"sort":0,"value_type":"cumulative"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:2793","format":"s","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:2794","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}}],"title":"Disk write latency by host","type":"row"}],"refresh":false,"schemaVersion":26,"style":"dark","tags":[],"templating":{"list":[{"allValue":null,"current":{"selected":true,"tags":[],"text":["patroni-01","patroni-04"],"value":["patroni-01","patroni-04"]},"hide":0,"includeAll":true,"label":null,"multi":true,"name":"node","options":[{"selected":false,"text":"All","value":"$__all"},{"selected":true,"text":"patroni-01","value":"patroni-01"},{"selected":false,"text":"patroni-02","value":"patroni-02"},{"selected":false,"text":"patroni-03","value":"patroni-03"},{"selected":true,"text":"patroni-04","value":"patroni-04"},{"selected":false,"text":"patroni-05","value":"patroni-05"},{"selected":false,"text":"patroni-06","value":"patroni-06"},{"selected":false,"text":"patroni-07","value":"patroni-07"},{"selected":false,"text":"patroni-08","value":"patroni-08"}],"query":"patroni-01,patroni-02,patroni-03,patroni-04,patroni-05,patroni-06,patroni-07,patroni-08","queryValue":"","skipUrlSync":false,"type":"custom"}]},"time":{"from":"2021-01-22T11:10:00.000Z","to":"2021-01-22T11:45:00.000Z"},"timepicker":{},"timezone":"","title":"msmiley - postgres - disk latency induced client connection spikes Copy","uid":"YGZyMQBMz","version":3}}