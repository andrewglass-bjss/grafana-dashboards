{"meta":{"type":"db","canSave":false,"canEdit":true,"canAdmin":false,"canStar":true,"slug":"alerts-gitaly-capacity-planner","url":"/d/alerts-gitaly_capacity_planner/alerts-gitaly-capacity-planner","expires":"0001-01-01T00:00:00Z","created":"2021-09-09T11:09:03Z","updated":"2021-09-09T11:09:03Z","updatedBy":"ops-contact@gitlab.com","createdBy":"ops-contact@gitlab.com","version":1,"hasAcl":false,"isFolder":false,"folderId":1107,"folderTitle":"Alerts","folderUrl":"/dashboards/f/alerts/alerts","provisioned":false,"provisionedExternalId":""},"dashboard":{"__inputs":[],"__requires":[],"annotations":{"list":[{"builtIn":1,"datasource":"-- Grafana --","enable":false,"hide":false,"iconColor":"#96D98D","name":"deploy","showIn":0,"tags":["deploy","$environment"],"type":"tags"},{"builtIn":1,"datasource":"-- Grafana --","enable":false,"hide":false,"iconColor":"#FFEE52","name":"canary-deploy","showIn":0,"tags":["deploy","${environment}-cny"],"type":"tags"},{"builtIn":1,"datasource":"-- Grafana --","enable":false,"hide":false,"iconColor":"#CA95E5","name":"feature-flags","showIn":0,"tags":["feature-flag","${environment}"],"type":"tags"}]},"description":"Uploaded by andrewn at Thu  9 Sep 2021 11:09:02 UTC","editable":false,"gnetId":null,"graphTooltip":1,"hideControls":false,"id":null,"links":[],"panels":[{"content":"# Gitaly Capacity Planning Dashboard\n\nThis dashboard helps estimate the number of additional Gitaly nodes that will be needed\nto be provisioned in order to meet a specific capacity target. This capacity is measured as\nthe total used capacity across all Gitaly nodes.\n\nThe \n","datasource":null,"gridPos":{"h":15,"w":24,"x":0,"y":0},"id":2,"mode":"markdown","title":"Help","type":"text"},{"gridPos":{"h":15,"w":24,"x":0,"y":15},"id":3,"links":[],"options":{"colorMode":"background","fieldOptions":{"calcs":["lastNotNull"],"defaults":{"decimals":0,"links":[],"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"light-red","value":null}]},"title":"Additional Gitaly Servers Required","unit":"new nodes"},"overrides":[],"values":false},"graphMode":"none","justifyMode":"auto","orientation":"vertical"},"pluginVersion":"6.6.1","targets":[{"expr":"clamp_min(\n  ceil(\n    (\n      (sum  by (environment, tier, type, stage, shard) (\n        node_filesystem_size_bytes{type=\"gitaly\", device=\"/dev/sdb\", env=\"$environment\", shard=\"$shard\", stage=\"$stage\"}\n        -\n        node_filesystem_free_bytes{type=\"gitaly\", device=\"/dev/sdb\", env=\"$environment\", shard=\"$shard\", stage=\"$stage\"}\n      )\n      /\n      avg by (environment, tier, type, stage, shard) (\n        node_filesystem_size_bytes{type=\"gitaly\", device=\"/dev/sdb\", env=\"$environment\", shard=\"$shard\", stage=\"$stage\"}\n      )\n    )\n    /\n    $target_capacity\n    )\n    -\n    count by (environment, tier, type, stage, shard) (\n      node_filesystem_size_bytes{type=\"gitaly\", device=\"/dev/sdb\", env=\"$environment\", shard=\"$shard\", stage=\"$stage\"}\n    )\n  ), 0\n)\n","format":"time_series","instant":true,"interval":"1m","intervalFactor":3,"legendFormat":"Shard {{ shard }}"}],"title":"Additional Gitaly Servers Required","type":"stat"},{"content":"Made with ❤️ and [Grafonnet](https://github.com/grafana/grafonnet-lib). [Contribute to this dashboard on GitLab.com](https://gitlab.com/gitlab-com/runbooks/blob/master/dashboards)\n","datasource":null,"gridPos":{"h":2,"w":24,"x":0,"y":110000},"id":4,"mode":"markdown","title":"Source","type":"text"}],"refresh":"","rows":[],"schemaVersion":16,"style":"light","tags":["managed","alerts","alert-target","gcp"],"templating":{"list":[{"current":{"text":"Global","value":"Global"},"hide":0,"label":null,"name":"PROMETHEUS_DS","options":[],"query":"prometheus","refresh":1,"regex":"","type":"datasource"},{"allValue":null,"current":{"text":"gprd","value":"gprd"},"datasource":"$PROMETHEUS_DS","hide":0,"includeAll":false,"label":null,"multi":false,"name":"environment","options":[],"query":"label_values(gitlab_service_ops:rate, environment)","refresh":1,"regex":"","sort":1,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"allValue":null,"current":{},"datasource":"$PROMETHEUS_DS","hide":0,"includeAll":false,"label":null,"multi":false,"name":"shard","options":[],"query":"label_values(node_filesystem_size_bytes{type=\"gitaly\", device=\"/dev/sdb\", env=\"$environment\"}, shard)","refresh":1,"regex":"","sort":1,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"allValue":null,"current":{},"datasource":"$PROMETHEUS_DS","hide":0,"includeAll":false,"label":null,"multi":false,"name":"stage","options":[],"query":"label_values(node_filesystem_size_bytes{type=\"gitaly\", device=\"/dev/sdb\", env=\"$environment\", shard=\"$shard\"}, stage)","refresh":1,"regex":"","sort":1,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"allValue":null,"current":{"text":"0.7","value":"0.7"},"hide":0,"includeAll":false,"label":"","multi":false,"name":"target_capacity","options":[{"text":"0.5","value":"0.5"},{"text":"0.55","value":"0.55"},{"text":"0.6","value":"0.6"},{"text":"0.65","value":"0.65"},{"text":"0.7","value":"0.7"},{"text":"0.75","value":"0.75"},{"text":"0.8","value":"0.8"},{"text":"0.85","value":"0.85"},{"text":"0.9","value":"0.9"},{"text":"0.95","value":"0.95"}],"query":"0.5,0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9,0.95","refresh":0,"type":"custom"}]},"time":{"from":"now-6h/m","to":"now/m"},"timepicker":{"refresh_intervals":["5s","10s","30s","1m","5m","15m","30m","1h","2h","1d"],"time_options":["5m","15m","1h","6h","12h","24h","2d","7d","30d"]},"timezone":"utc","title":"alerts: Gitaly Capacity Planner","uid":"alerts-gitaly_capacity_planner","version":1}}