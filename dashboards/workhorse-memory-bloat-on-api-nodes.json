{"meta":{"type":"db","canSave":false,"canEdit":true,"canAdmin":false,"canStar":true,"slug":"workhorse-memory-bloat-on-api-nodes","url":"/d/_uj9rXNGk/workhorse-memory-bloat-on-api-nodes","expires":"0001-01-01T00:00:00Z","created":"2020-08-27T23:39:25Z","updated":"2020-08-28T01:25:33Z","updatedBy":"ops-contact@gitlab.com","createdBy":"ops-contact@gitlab.com","version":4,"hasAcl":false,"isFolder":false,"folderId":955,"folderTitle":"RCAs","folderUrl":"/dashboards/f/rcas/rcas","provisioned":false,"provisionedExternalId":""},"dashboard":{"annotations":{"list":[{"builtIn":1,"datasource":"-- Grafana --","enable":true,"hide":true,"iconColor":"rgba(0, 211, 255, 1)","name":"Annotations \u0026 Alerts","type":"dashboard"}]},"editable":true,"gnetId":null,"graphTooltip":1,"id":null,"links":[],"panels":[{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":11,"w":23,"x":0,"y":0},"hiddenSeries":false,"id":2,"legend":{"alignAsTable":true,"avg":false,"current":false,"max":true,"min":false,"rightSide":false,"show":true,"total":false,"values":true},"lines":true,"linewidth":1,"nullPointMode":"null","options":{"dataLinks":[]},"percentage":false,"pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"sum(avg_over_time(backend_code:haproxy_server_http_responses_total:irate1m{env=\"gprd\",monitor=\"default\",code=\"5xx\",backend=\"api\"}[$__interval])) by (backend)","interval":"","legendFormat":"{{backend}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Rate of HTTP 5xx errors seen by HAProxy from API hosts","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:40","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:41","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"Normally workhorse has a modest used memory footprint of roughly 100 MB, but under some conditions it spikes enormously to 10-50 GB.  This graph helps find those usage spikes.","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":11,"w":23,"x":0,"y":11},"hiddenSeries":false,"id":4,"legend":{"alignAsTable":true,"avg":false,"current":true,"max":true,"min":false,"rightSide":false,"show":true,"total":false,"values":true},"lines":true,"linewidth":1,"nullPointMode":"null","options":{"dataLinks":[]},"percentage":false,"pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"go_memstats_alloc_bytes{job=\"gitlab-workhorse-api\", type=\"api\", environment=\"gprd\"} \u003e 10*1024^3","interval":"","legendFormat":"{{fqdn}}","refId":"A"},{"expr":"","interval":"","legendFormat":"","refId":"B"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Workhorse memory alloc \u003e 10 GB on API nodes","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:40","format":"bytes","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:41","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":null,"description":"From the go runtime's perspective, compare used vs total size of the heap.  The total heap size (\"go_memstats_heap_sys_bytes\") is typically most of the memory allocated by the OS to this process, and golang's internal heap allocator may retain that memory after it is reclaimed by the garbage collector, rather than release it back to the OS.","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":11,"w":23,"x":0,"y":22},"hiddenSeries":false,"id":3,"legend":{"alignAsTable":true,"avg":false,"current":true,"max":true,"min":false,"rightSide":false,"show":true,"total":false,"values":true},"lines":true,"linewidth":1,"nullPointMode":"null","options":{"dataLinks":[]},"percentage":false,"pointradius":2,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"go_memstats_alloc_bytes{job=\"gitlab-workhorse-api\", type=\"api\", environment=\"gprd\", fqdn=\"api-06-sv-gprd.c.gitlab-production.internal\"}","interval":"","legendFormat":"used heap","refId":"A"},{"expr":"go_memstats_heap_sys_bytes{job=\"gitlab-workhorse-api\", type=\"api\", environment=\"gprd\", fqdn=\"api-06-sv-gprd.c.gitlab-production.internal\"}","interval":"","legendFormat":"total heap","refId":"B"},{"expr":"go_memstats_sys_bytes{job=\"gitlab-workhorse-api\", type=\"api\", environment=\"gprd\", fqdn=\"api-06-sv-gprd.c.gitlab-production.internal\"}","hide":true,"interval":"","legendFormat":"{{fqdn}} sys","refId":"C"},{"expr":"process_resident_memory_bytes{job=\"gitlab-workhorse-api\", type=\"api\", environment=\"gprd\", fqdn=\"api-06-sv-gprd.c.gitlab-production.internal\"}","hide":true,"interval":"","legendFormat":"{{fqdn}} rss","refId":"D"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Used vs Total heap size - api-06","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:40","format":"bytes","label":null,"logBase":1,"max":null,"min":null,"show":true},{"$$hashKey":"object:41","format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}],"yaxis":{"align":false,"alignLevel":null}}],"refresh":false,"schemaVersion":25,"style":"dark","tags":[],"templating":{"list":[]},"time":{"from":"2020-08-27T15:00:00.000Z","to":"2020-08-27T22:00:00.000Z"},"timepicker":{"refresh_intervals":["10s","30s","1m","5m","15m","30m","1h","2h","1d"]},"timezone":"utc","title":"Workhorse memory bloat on API nodes","uid":"_uj9rXNGk","version":4}}