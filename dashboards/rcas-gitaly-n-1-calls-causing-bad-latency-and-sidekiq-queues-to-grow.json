{"meta":{"type":"db","canSave":false,"canEdit":false,"canAdmin":false,"canStar":true,"slug":"rcas-gitaly-n-1-calls-causing-bad-latency-and-sidekiq-queues-to-grow","url":"/d/rcas-7479/rcas-gitaly-n-1-calls-causing-bad-latency-and-sidekiq-queues-to-grow","expires":"0001-01-01T00:00:00Z","created":"2019-08-08T19:42:09Z","updated":"2019-08-08T20:19:46Z","updatedBy":"ops-contact@gitlab.com","createdBy":"ops-contact@gitlab.com","version":16,"hasAcl":false,"isFolder":false,"folderId":955,"folderTitle":"RCAs","folderUrl":"/dashboards/f/rcas/rcas","provisioned":false,"provisionedExternalId":""},"dashboard":{"__inputs":[],"__requires":[],"annotations":{"list":[{"datasource":"Pagerduty","enable":true,"hide":false,"iconColor":"#F2495C","limit":100,"name":"GitLab Production Pagerduty","serviceId":"PATDFCE","showIn":0,"tags":[],"type":"tags","urgency":"high"},{"datasource":"Pagerduty","enable":true,"hide":false,"iconColor":"#C4162A","limit":100,"name":"GitLab Production SLO","serviceId":"P7Q44DU","showIn":0,"tags":[],"type":"tags","urgency":"high"},{"datasource":"Simple Annotations","enable":true,"hide":false,"iconColor":"#5794F2","limit":100,"name":"Key Events","queries":[{"date":"2019-08-07T23:00:00Z","text":"Group Zero generates large amount of WebHook, ProjectServer activity"},{"date":"2019-08-08T00:30:00Z","text":"First CPU Spikes"},{"date":"2019-08-07T19:22:35.966Z","text":"123123123123123123"}],"showIn":0,"tags":[],"type":"tags"}]},"editable":false,"gnetId":null,"graphTooltip":1,"hideControls":false,"id":null,"links":[],"panels":[{"content":"\nGroup zero seems to start generating push activity at about 23h00 hours.\n\nThe first sign of a problem was CPU spikes on some Gitaly nodes.\nThis occurred as Gitaly struggled with _O(n^2)_ `FindAllTag` queries,\ngenerated by `PostReceiveWorkers`.\n  ","gridPos":{"h":10,"w":12,"x":0,"y":1},"id":2,"mode":"markdown","title":"CPU on Gitaly","type":"text"},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":0,"description":"","fill":0,"gridPos":{"h":10,"w":12,"x":12,"y":1},"id":3,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"total":false,"values":true},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","percentage":false,"pointradius":5,"points":false,"renderer":"flot","repeat":null,"seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"clamp_min(clamp_max(\n      avg(instance_cpu:node_cpu_seconds_not_idle:rate1m{type=\"gitaly\", environment=\"gprd\"}) by (fqdn)\n    ,1),0)","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{ fqdn }}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Gitaly Node CPU","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"percentunit","label":"CPU","logBase":1,"max":1,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":1,"min":0,"show":false}]},{"content":"\nThe `FindAllTags` will return multiple messages for each request made.\nThis is to ensure that each messages is kept reasonably small.\nBy calculating the average message size, we can detect if Gitaly is having\nto deal with very large tag payloads.\n  ","gridPos":{"h":10,"w":12,"x":0,"y":11},"id":4,"mode":"markdown","title":"FindAllTags","type":"text"},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":0,"description":"","fill":0,"gridPos":{"h":10,"w":12,"x":12,"y":11},"id":5,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"total":false,"values":true},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","percentage":false,"pointradius":5,"points":false,"renderer":"flot","repeat":null,"seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"\n      grpc_server_msg_sent_total{grpc_method=\"FindAllTags\", environment=\"gprd\"}\n      /\n      grpc_server_started_total{grpc_method=\"FindAllTags\", environment=\"gprd\"}\n    ","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{ fqdn }}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"FindAllTags Response Size","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":"Average messages per FindAllTags request","logBase":1,"max":null,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":1,"min":0,"show":false}]},{"content":"\n  ","gridPos":{"h":10,"w":12,"x":0,"y":21},"id":6,"mode":"markdown","title":"Queue Length","type":"text"},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":0,"description":"","fill":0,"gridPos":{"h":10,"w":12,"x":12,"y":21},"id":7,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"total":false,"values":true},"lines":true,"linewidth":1,"links":[],"nullPointMode":"null","percentage":false,"pointradius":5,"points":false,"renderer":"flot","repeat":null,"seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"\n      sidekiq_queue_size{environment=\"$environment\", name=~\"web_hook|project_service|post_receive\"} and on(fqdn) (redis_connected_slaves != 0)\n    ","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{ name }}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Queue Length","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":"Queue Length","logBase":1,"max":null,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":1,"min":0,"show":false}]}],"refresh":"","rows":[],"schemaVersion":16,"style":"dark","tags":["managed","rcas","rca"],"templating":{"list":[{"current":{"text":"Prometheus","value":"Prometheus"},"hide":0,"label":null,"name":"PROMETHEUS_DS","options":[],"query":"prometheus","refresh":1,"regex":"/(.*-gprd|Global)/","type":"datasource"},{"allValue":null,"current":{"text":"gprd","value":"gprd"},"datasource":"$PROMETHEUS_DS","hide":0,"includeAll":false,"label":null,"multi":false,"name":"environment","options":[],"query":"label_values(gitlab_service_ops:rate, environment)","refresh":1,"regex":"","sort":1,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false}]},"time":{"from":"2019-08-07 22:00:00","to":"2019-08-08 18:00:00"},"timepicker":{"refresh_intervals":["5s","10s","30s","1m","5m","15m","30m","1h","2h","1d"],"time_options":["5m","15m","1h","6h","12h","24h","2d","7d","30d"]},"timezone":"UTC","title":"rcas: Gitaly n+1 calls causing bad latency and sidekiq queues to grow","uid":"rcas-7479","version":16}}